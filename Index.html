import React, { useState } from ‘react’;
import { Upload, TrendingUp, DollarSign, Target, Zap, BookOpen, Info } from ‘lucide-react’;

const OptionsAnalyzer = () => {
const [uploadedImage, setUploadedImage] = useState(null);
const [ticker, setTicker] = useState(’’);
const [manualTicker, setManualTicker] = useState(’’);
const [optionsData, setOptionsData] = useState(null);
const [stockPrice, setStockPrice] = useState(null);
const [loading, setLoading] = useState(false);
const [error, setError] = useState(null);
const [analysis, setAnalysis] = useState(null);
const [analyzingChart, setAnalyzingChart] = useState(false);

const POLYGON_API_KEY = ‘A5mQSGEQCpkNpcypdYwygoFUmP12t3OM’;

const handleImageUpload = async (e) => {
const file = e.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = async (event) => {
setUploadedImage(event.target.result);
await analyzeChart(event.target.result);
};
reader.readAsDataURL(file);
};

const analyzeChart = async (base64Image) => {
setAnalyzingChart(true);
setError(null);
try {
const imageData = base64Image.split(’,’)[1];
const response = await fetch(“https://api.anthropic.com/v1/messages”, {
method: “POST”,
headers: { “Content-Type”: “application/json” },
body: JSON.stringify({
model: “claude-sonnet-4-20250514”,
max_tokens: 4000,
messages: [{
role: “user”,
content: [{
type: “image”,
source: { type: “base64”, media_type: “image/jpeg”, data: imageData }
}, {
type: “text”,
text: `Analyze using The Strat. Respond ONLY with valid JSON (no markdown):

{
“ticker”: “SYMBOL”,
“currentPrice”: 123.45,
“stratPattern”: {
“type”: “2-1-2 reversal”,
“description”: “what pattern shows”,
“significance”: “why it matters”,
“momentum”: “high/medium/low”,
“momentumExplanation”: “momentum details”
},
“technicalAnalysis”: {
“trend”: “bullish/bearish/neutral”,
“keyLevels”: { “resistance”: [125, 128], “support”: [120, 118] },
“ftfc”: “FTFC status”,
“timeframeAlignment”: “timeframe details”
},
“tradeSetup”: {
“direction”: “call/put”,
“entryZone”: “$120-$121”,
“stopLoss”: “$118 below support”,
“profitTargets”: [
{“target”: 1, “price”: 125, “rationale”: “first resistance”, “percentGain”: “4%”, “action”: “Take 33% off”},
{“target”: 2, “price”: 128, “rationale”: “major level”, “percentGain”: “6%”, “action”: “Take 33% off”},
{“target”: 3, “price”: 132, “rationale”: “extension”, “percentGain”: “9%”, “action”: “Final exit”}
],
“riskRewardRatio”: “1:3”
},
“laymansExplanation”: “Plain English explanation”,
“technicalExplanation”: “Advanced technical breakdown”
}

If low momentum, set profitTargets to []. Output ONLY JSON.` }] }] }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const data = await response.json(); let text = data.content[0].text.trim().replace(/```json\n?/g, "").replace(/```\n?/g, "").trim(); const match = text.match(/\{[\s\S]*\}/); if (match) text = match[0]; const result = JSON.parse(text); setAnalysis(result); setTicker(result.ticker); if (result.ticker) await fetchOptionsData(result.ticker); } catch (err) { setError(`Analysis failed: ${err.message}. Try manual entry.`);
} finally {
setAnalyzingChart(false);
}
};

const fetchStockPrice = async (symbol) => {
try {
const res = await fetch(`https://api.polygon.io/v2/aggs/ticker/${symbol}/prev?apiKey=${POLYGON_API_KEY}`);
if (!res.ok) throw new Error(‘Price fetch failed’);
const data = await res.json();
return data.results?.[0]?.c || null;
} catch (err) {
return null;
}
};

const fetchOptionsData = async (symbol) => {
setLoading(true);
setError(null);
try {
const price = await fetchStockPrice(symbol);
setStockPrice(price);
const today = new Date();
const future = new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
const res = await fetch(
`https://api.polygon.io/v3/reference/options/contracts?underlying_ticker=${symbol}&expiration_date.gte=${today.toISOString().split('T')[0]}&expiration_date.lte=${future.toISOString().split('T')[0]}&limit=1000&apiKey=${POLYGON_API_KEY}`
);
if (!res.ok) throw new Error(‘Options fetch failed’);
const data = await res.json();
if (!data.results?.length) throw new Error(‘No options available’);
setOptionsData(processOptionsData(data.results, price));
} catch (err) {
setError(err.message);
} finally {
setLoading(false);
}
};

const processOptionsData = (contracts, currentPrice) => {
const expirations = {};
const strikes = new Set();
contracts.forEach(c => {
const exp = c.expiration_date;
if (!expirations[exp]) expirations[exp] = { calls: [], puts: [] };
const opt = { ticker: c.ticker, strike: c.strike_price, type: c.contract_type, expiration: exp };
strikes.add(c.strike_price);
c.contract_type === ‘call’ ? expirations[exp].calls.push(opt) : expirations[exp].puts.push(opt);
});
const nearStrikes = Array.from(strikes).sort((a, b) => a - b).filter(s => s >= currentPrice * 0.9 && s <= currentPrice * 1.1);
const sortedExps = Object.keys(expirations).sort().slice(0, 6);
return {
expirations: sortedExps.map(exp => ({ date: exp, calls: expirations[exp].calls, puts: expirations[exp].puts })),
recommendedStrikes: nearStrikes.slice(0, 10),
currentPrice
};
};

const getMomentumColor = (m) => m === ‘high’ ? ‘text-green-400’ : m === ‘medium’ ? ‘text-yellow-400’ : ‘text-red-400’;
const getMomentumBg = (m) => m === ‘high’ ? ‘bg-green-500/20 border-green-500/50’ : m === ‘medium’ ? ‘bg-yellow-500/20 border-yellow-500/50’ : ‘bg-red-500/20 border-red-500/50’;

return (
<div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4">
<div className="max-w-7xl mx-auto">
<div className="text-center mb-6 pt-6">
<h1 className="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
<TrendingUp className="text-green-400" size={40} />
The Strat Options Analyzer
</h1>
<p className="text-blue-200">AI Strat Analysis + 3 Profit Targets + Real-Time Options</p>
</div>

```
    <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
      <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
        <Upload size={24} />Upload Chart or Enter Ticker
      </h2>
      <div className="grid md:grid-cols-2 gap-4">
        <div className="border-2 border-dashed border-blue-400 rounded-xl p-6 text-center hover:border-green-400 transition-colors">
          <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" id="chart-upload" />
          <label htmlFor="chart-upload" className="cursor-pointer">
            <Upload className="mx-auto mb-3 text-blue-300" size={48} />
            <p className="text-white font-medium mb-1">Upload Trading Chart</p>
            <p className="text-sm text-blue-200">AI analyzes Strat + momentum</p>
          </label>
        </div>
        <div className="border-2 border-blue-400 rounded-xl p-6">
          <label className="block text-white font-medium mb-2">Or Enter Ticker</label>
          <input type="text" value={manualTicker} onChange={(e) => setManualTicker(e.target.value.toUpperCase())}
            placeholder="INTC, AAPL, TSLA" className="w-full px-4 py-3 rounded-lg bg-white/20 text-white border border-white/30 placeholder-blue-200 focus:outline-none focus:border-green-400 mb-3" />
          <button onClick={() => manualTicker.trim() && fetchOptionsData(manualTicker.toUpperCase())}
            className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg">Fetch Options</button>
        </div>
      </div>
      {uploadedImage && <div className="mt-6"><img src={uploadedImage} alt="Chart" className="rounded-lg max-h-64 mx-auto border-2 border-blue-400" /></div>}
    </div>

    {(loading || analyzingChart) && (
      <div className="bg-white/10 rounded-2xl p-8 mb-6 text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-400 mx-auto mb-4"></div>
        <p className="text-white text-lg">{analyzingChart ? 'Analyzing Strat...' : 'Fetching options...'}</p>
      </div>
    )}

    {error && <div className="bg-red-500/20 rounded-2xl p-4 mb-6 border border-red-500/50"><p className="text-red-200">{error}</p></div>}

    {analysis && (
      <>
        {analysis.stratPattern && (
          <div className="bg-gradient-to-r from-purple-500/20 to-blue-500/20 rounded-2xl p-6 mb-6 border-2 border-purple-400/50">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <Target size={28} className="text-purple-400" />Strat: {analysis.stratPattern.type}
            </h2>
            <div className="space-y-4">
              <div className="bg-white/10 rounded-lg p-4">
                <h3 className="text-purple-300 font-semibold mb-2">Description</h3>
                <p className="text-white text-lg">{analysis.stratPattern.description}</p>
              </div>
              <div className="bg-white/10 rounded-lg p-4">
                <h3 className="text-purple-300 font-semibold mb-2">Significance</h3>
                <p className="text-white">{analysis.stratPattern.significance}</p>
              </div>
              <div className={`rounded-lg p-4 border-2 ${getMomentumBg(analysis.stratPattern.momentum)}`}>
                <div className="flex items-center gap-3 mb-2">
                  <Zap className={getMomentumColor(analysis.stratPattern.momentum)} size={24} />
                  <h3 className={`font-bold text-xl ${getMomentumColor(analysis.stratPattern.momentum)} uppercase`}>
                    {analysis.stratPattern.momentum} MOMENTUM
                  </h3>
                </div>
                <p className="text-white">{analysis.stratPattern.momentumExplanation}</p>
              </div>
            </div>
          </div>
        )}

        {analysis.laymansExplanation && (
          <div className="bg-green-500/20 rounded-2xl p-6 mb-6 border-2 border-green-400/50">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <BookOpen size={28} className="text-green-400" />Simple Explanation
            </h2>
            <div className="bg-white/10 rounded-lg p-5">
              <p className="text-white text-lg leading-relaxed">{analysis.laymansExplanation}</p>
            </div>
          </div>
        )}

        {analysis.tradeSetup && (
          <div className="bg-blue-500/20 rounded-2xl p-6 mb-6 border-2 border-blue-400/50">
            <h2 className="text-2xl font-bold text-white mb-4">Trade Setup: {ticker}</h2>
            <div className="grid md:grid-cols-2 gap-4 mb-6">
              <div className="bg-white/10 rounded-lg p-4">
                <h3 className="text-blue-300 font-semibold mb-2">Direction</h3>
                <p className="text-white text-2xl font-bold uppercase">{analysis.tradeSetup.direction}</p>
              </div>
              <div className="bg-white/10 rounded-lg p-4">
                <h3 className="text-blue-300 font-semibold mb-2">Risk/Reward</h3>
                <p className="text-white text-2xl font-bold">{analysis.tradeSetup.riskRewardRatio}</p>
              </div>
              <div className="bg-green-500/20 rounded-lg p-4 border border-green-500/50">
                <h3 className="text-green-300 font-semibold mb-2">Entry Zone</h3>
                <p className="text-white text-lg font-bold">{analysis.tradeSetup.entryZone}</p>
              </div>
              <div className="bg-red-500/20 rounded-lg p-4 border border-red-500/50">
                <h3 className="text-red-300 font-semibold mb-2">Stop Loss</h3>
                <p className="text-white text-lg font-bold">{analysis.tradeSetup.stopLoss}</p>
              </div>
            </div>

            {analysis.tradeSetup.profitTargets?.length > 0 ? (
              <div>
                <h3 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                  <Zap className="text-yellow-400" size={24} />3 Profit Targets
                </h3>
                <div className="grid md:grid-cols-3 gap-4">
                  {analysis.tradeSetup.profitTargets.map((t, i) => (
                    <div key={i} className="bg-gradient-to-br from-yellow-500/20 to-green-500/20 rounded-lg p-5 border-2 border-yellow-400/50">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="text-yellow-400 font-bold text-2xl">Target {t.target}</h4>
                        <span className="text-green-400 font-bold text-xl">{t.percentGain}</span>
                      </div>
                      <div className="space-y-2">
                        <div className="bg-white/10 rounded p-2">
                          <p className="text-blue-200 text-xs mb-1">Price</p>
                          <p className="text-white text-xl font-bold">${t.price}</p>
                        </div>
                        <div className="bg-white/10 rounded p-2">
                          <p className="text-blue-200 text-xs mb-1">Why</p>
                          <p className="text-white text-sm">{t.rationale}</p>
                        </div>
                        <div className="bg-green-500/20 rounded p-2 border border-green-500/50">
                          <p className="text-green-300 text-xs mb-1">Action</p>
                          <p className="text-white font-semibold text-sm">{t.action}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="bg-yellow-500/20 rounded-lg p-5 border border-yellow-500/50">
                <h3 className="text-yellow-400 font-bold mb-2">Limited Targets</h3>
                <p className="text-white">Not enough momentum for 3 targets. See momentum analysis above.</p>
              </div>
            )}
          </div>
        )}

        {analysis.technicalExplanation && (
          <div className="bg-white/10 rounded-2xl p-6 mb-6 border border-white/20">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <Info size={24} className="text-orange-400" />Technical Breakdown
            </h2>
            <div className="bg-white/5 rounded-lg p-5">
              <p className="text-white leading-relaxed">{analysis.technicalExplanation}</p>
            </div>
          </div>
        )}
      </>
    )}

    {optionsData && stockPrice && (
      <div className="bg-white/10 rounded-2xl p-6 mb-6 border border-white/20">
        <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
          <DollarSign size={24} className="text-green-400" />Real-Time Options: {ticker}
        </h2>
        <div className="bg-green-500/20 rounded-lg p-4 mb-6 border border-green-500/50">
          <h3 className="text-green-400 font-semibold mb-2">Live Stock Price</h3>
          <p className="text-white text-3xl font-bold">${stockPrice.toFixed(2)}</p>
        </div>
        <div className="mb-6">
          <h3 className="text-xl font-bold text-white mb-3">Expirations</h3>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
            {optionsData.expirations.map((exp, i) => (
              <div key={i} className="bg-white/5 rounded-lg p-3 border border-blue-400/30">
                <p className="text-white font-medium">{exp.date}</p>
                <p className="text-blue-200 text-sm">{exp.calls.length} calls, {exp.puts.length} puts</p>
              </div>
            ))}
          </div>
        </div>
        <div className="mb-6">
          <h3 className="text-xl font-bold text-white mb-3">Strikes Near Price</h3>
          <div className="bg-white/5 rounded-lg p-4">
            <div className="flex flex-wrap gap-2">
              {optionsData.recommendedStrikes.map((s, i) => (
                <div key={i} className={`px-4 py-2 rounded-lg font-medium ${Math.abs(s - stockPrice) < 1 ? 'bg-green-500/30 border-2 border-green-400 text-green-300' : 'bg-white/10 border border-white/20 text-white'}`}>
                  ${s.toFixed(2)}
                </div>
              ))}
            </div>
          </div>
        </div>
        {optionsData.expirations[0] && (
          <div>
            <h3 className="text-xl font-bold text-white mb-3">Next Expiry: {optionsData.expirations[0].date}</h3>
            <div className="grid md:grid-cols-2 gap-4">
              <div className="bg-green-500/10 rounded-lg p-4 border border-green-500/30">
                <h4 className="text-green-400 font-bold mb-3">CALLS</h4>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {optionsData.expirations[0].calls.filter(c => optionsData.recommendedStrikes.includes(c.strike)).sort((a, b) => a.strike - b.strike).map((c, i) => (
                    <div key={i} className="bg-white/10 rounded p-3">
                      <div className="flex justify-between items-center">
                        <span className="text-white font-bold">${c.strike}</span>
                        <span className={`text-sm ${c.strike < stockPrice ? 'text-green-400' : 'text-blue-200'}`}>{c.strike < stockPrice ? 'ITM' : 'OTM'}</span>
                      </div>
                      <p className="text-xs text-blue-200">{c.ticker}</p>
                    </div>
                  ))}
                </div>
              </div>
              <div className="bg-red-500/10 rounded-lg p-4 border border-red-500/30">
                <h4 className="text-red-400 font-bold mb-3">PUTS</h4>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {optionsData.expirations[0].puts.filter(p => optionsData.recommendedStrikes.includes(p.strike)).sort((a, b) => b.strike - a.strike).map((p, i) => (
                    <div key={i} className="bg-white/10 rounded p-3">
                      <div className="flex justify-between items-center">
                        <span className="text-white font-bold">${p.strike}</span>
                        <span className={`text-sm ${p.strike > stockPrice ? 'text-green-400' : 'text-blue-200'}`}>{p.strike > stockPrice ? 'ITM' : 'OTM'}</span>
                      </div>
                      <p className="text-xs text-blue-200">{p.ticker}</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    )}

    <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
      <p className="text-blue-200 text-sm text-center">✅ Strat Analysis + 3 Targets + Real-Time Polygon Data</p>
    </div>
  </div>
</div>
```

);
};

export default OptionsAnalyzer;
